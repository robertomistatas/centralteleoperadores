rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Funci√≥n auxiliar para verificar si es super admin
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.email == 'roberto@mistatas.com';
    }
    
    // Funci√≥n auxiliar para verificar acceso de administrador
    function isAdmin() {
      return isSuperAdmin() || (
        request.auth != null && 
        exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role in ['admin', 'super_admin']
      );
    }
    
    // Operadores - solo el due√±o puede leer/escribir, pero teleoperadoras pueden leer todos para encontrarse
    match /operators/{document} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // üî• NUEVA REGLA: Teleoperadoras pueden leer todos los operadores para encontrar su registro
      allow read: if request.auth != null && (
        exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'teleoperadora'
      );
      
      // üî• NUEVA REGLA: Cualquier usuario autenticado puede leer todos los operadores
      allow read: if request.auth != null;
    }
    
    // Asignaciones - solo el due√±o puede leer/escribir, pero teleoperadoras pueden leer todas para encontrar las suyas
    match /assignments/{document} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // üî• NUEVA REGLA: Teleoperadoras pueden leer todas las asignaciones para encontrar las suyas
      allow read: if request.auth != null && (
        exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'teleoperadora'
      );
      
      // üî• NUEVA REGLA: Cualquier usuario autenticado puede leer todas las asignaciones
      allow read: if request.auth != null;
    }
    
    // Datos de llamadas - solo el due√±o puede leer/escribir
    match /callData/{document} {
      allow read, write: if request.auth != null && document == request.auth.uid;
    }
    
    // Datos de usuario - solo el due√±o puede leer/escribir
    match /userData/{document} {
      allow read, write: if request.auth != null && document == request.auth.uid;
    }
    
    // Beneficiarios - solo el due√±o puede leer/escribir
    match /beneficiaries/{document} {
      allow read, write: if request.auth != null && resource.data.creadoPor == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.creadoPor == request.auth.uid;
    }
    
    // Historial de cargas de beneficiarios - solo el due√±o puede leer/escribir
    match /beneficiaryUploads/{document} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }
    
    // Seguimientos peri√≥dicos - solo el due√±o puede leer/escribir
    match /seguimientos/{document} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }
    
    // ‚úÖ NUEVAS REGLAS PARA GESTI√ìN DE USUARIOS Y PERMISOS
    
    // Perfiles de usuario - Super admin puede gestionar todos, usuarios pueden leer el suyo
    match /userProfiles/{userId} {
      // Super admin puede leer y escribir todos los perfiles
      allow read, write, create, update, delete: if isSuperAdmin();
      
      // Usuarios pueden leer su propio perfil
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Admins pueden leer perfiles de usuarios bajo su jurisdicci√≥n
      allow read: if isAdmin() && request.auth != null;
    }
    
    // Configuraci√≥n del sistema - Solo super admin
    match /systemConfig/{document} {
      allow read, write: if isSuperAdmin();
    }
    
    // Logs de auditor√≠a - Super admin y admins pueden leer, sistema puede escribir
    match /auditLogs/{document} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
      allow create: if request.auth != null; // Cualquier usuario autenticado puede crear logs
    }
    
    // Roles y permisos - Solo super admin puede gestionar
    match /roles/{document} {
      allow read: if request.auth != null; // Todos pueden leer roles para validaci√≥n
      allow write: if isSuperAdmin();
    }
  }
}
